{% extends 'base_sonata_admin/show.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .encabezado .sonata-ba-view-container th { width: 220px; }
        .encabezado .table > tbody > tr > th,
        .encabezado .table > tbody > tr > td { vertical-align: middle; }

        /* --- Parche Anti-Subrayado Verde de nav-tabs-custom --- */
        .nav-tabs-custom > .nav-tabs > li.active,
        .nav-tabs-custom > .nav-tabs > li.active > a,
        .nav-tabs-custom > .nav-tabs > li.active > a:hover,
        .nav-tabs-custom > .nav-tabs > li.active > a:focus {
            border: none !important;
            border-top: 0 !important;
            border-bottom: 0 !important;
            border-left: 0 !important;
            border-right: 0 !important;
            box-shadow: none !important;
        }
        .nav-tabs-custom > .nav-tabs > li.active { border-top-color: transparent !important; }
        .nav-tabs-custom > .nav-tabs > li > a:hover,
        .nav-tabs-custom > .nav-tabs > li > a:focus { border-color: transparent !important; }
        .nav-tabs-custom > .nav-tabs > li.active,
        .nav-tabs-custom > .nav-tabs > li.active > a { border-color: transparent !important; }

        .tabs-modern { border-bottom: 0 !important; margin-bottom: 10px; }
        .tabs-modern.tabs-modern--multiline { display:flex; flex-wrap:wrap; align-items:stretch; }
        .tabs-modern.tabs-modern--multiline > li { float:none !important; display:block; flex:0 1 auto; margin:6px 6px 0 0; }
        .tabs-modern > li > a,
        .tabs-modern > li > a:hover,
        .tabs-modern > li > a:focus,
        .tabs-modern > li.active > a,
        .tabs-modern > li.active > a:hover,
        .tabs-modern > li.active > a:focus { text-decoration:none !important; }
        .tabs-modern > li > a {
            position: relative; padding:10px 14px; font-weight:600; color:#667085; background:transparent;
            letter-spacing:.2px; transition: color .2s, background-color .2s, border-color .2s; border:none !important;
            white-space:nowrap; line-height:1.25; outline:none;
        }
        .tabs-modern > li > a::after, .tabs-modern > li > a::before { display:none !important; content:none !important; }
        .tabs-modern > li > a .tab-icon { margin-right:6px; opacity:.9; font-size:.95em; }
        .tabs-modern.tabs-modern--pill > li > a { border-radius:18px; padding:8px 14px; border:1px solid transparent; }
        .tabs-modern.tabs-modern--pill > li > a:hover,
        .tabs-modern.tabs-modern--pill > li > a:focus { background:rgba(60,141,188,.08); color:var(--accent,#3c8dbc); border-color:var(--accent,#3c8dbc); }
        .tabs-modern.tabs-modern--pill > li.active > a,
        .tabs-modern.tabs-modern--pill > li.active > a:focus,
        .tabs-modern.tabs-modern--pill > li.active > a:hover { background:rgba(60,141,188,.12); color:var(--accent,#3c8dbc); border-color:var(--accent,#3c8dbc); }
        .tabs-modern--sm > li > a { font-size:13px; }
        .tabs-modern--sm.tabs-modern--pill > li > a { padding:6px 10px; border-radius:16px; }
        @media (min-width:768px){
            .tabs-modern--sm-desktop > li > a { font-size:13px; }
            .tabs-modern--sm-desktop.tabs-modern--pill > li > a { padding:6px 10px; border-radius:16px; }
        }

        .sonata-ba-view-container th .row-icon { margin-right:6px; opacity:.9; color:#667085; width:1.1em; text-align:center; }

        {% include 'reserva_reserva_admin/show__parte_galeria.css.twig' %}
    </style>
{% endblock %}

{% block show %}

    <div class="sonata-ba-view">
        {{ sonata_block_render_event('sonata.admin.show.top', { 'admin': admin, 'object': object }) }}

        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

                {# ============ Macro para filas del encabezado ============ #}
                {% macro itemRow(titulo, contenido) %}
                    <tr class="sonata-ba-view-container">
                        <th class="text-muted text-uppercase" style="width:145px; letter-spacing:.2px;">{{ titulo|raw }}</th>
                        <td>{{ contenido|raw }}</td>
                    </tr>
                {% endmacro %}
                {% from _self import itemRow %}

                <div class="box box-primary encabezado">
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-striped table-hover table-condensed">
                            <caption class="sr-only">Encabezado del alojamiento</caption>
                            <tbody>
                            {{ itemRow(
                                '<i class="fas fa-hotel row-icon" aria-hidden="true"></i> ' ~ ('alojamiento'|trans({}, 'messages')|capitalize),
                            '<strong>' ~ object.establecimiento.nombre ~ '</strong> ' ~ object.nombre
                            ) }}

                            {{ itemRow(
                                '<i class="fas fa-align-left row-icon" aria-hidden="true"></i> ' ~ ('descripcion'|trans({}, 'messages')|capitalize),
                            object.descripcion is not empty
                            ? object.descripcion
                            : '<span class="text-muted"><em>' ~ ( 'sin_descripcion'|trans({}, 'messages')|default('Sin descripción') ) ~ '</em></span>'
                            ) }}
                            </tbody>
                        </table>
                    </div>
                </div>

                {# =================== TABS =================== #}
                <div class="nav-tabs-custom">
                    <ul class="nav nav-tabs tabs-modern tabs-modern--pill tabs-modern--multiline tabs-modern--sm hidden-print" role="tablist">
                        {% set inicializado = false %}

                        {# Iterar sobre links (orden ya viene por @OrderBy en la colección) #}
                        {% for index, link in object.unitCaracteristicaLinks %}
                            {% set c = link.caracteristica %}
                            {% if c is not empty and not (
                                (c.unittipocaracteristica.id == constant('App\\Entity\\ReservaUnittipocaracteristica::DB_VALOR_BRIEFING') and action == 'resumen')
                                or
                                (c.unittipocaracteristica.id == constant('App\\Entity\\ReservaUnittipocaracteristica::DB_VALOR_INVENTARIO') and action == 'resumen')
                                ) %}
                                {% set idTab  = 'tab_' ~ admin.uniqid ~ '_' ~ index %}
                                {% set color  = c.unittipocaracteristica.iconcolor %}
                                <li role="presentation" class="{% if not inicializado %}active{% endif %}">
                                    <a href="#{{ idTab }}"
                                       role="tab"
                                       data-toggle="tab"
                                       aria-controls="{{ idTab }}"
                                       aria-selected="{{ (not inicializado) ? 'true' : 'false' }}"
                                       style="--accent: {{ color }};">
                                        <i class="fas {{ c.unittipocaracteristica.iconclase }} tab-icon" aria-hidden="true"></i>
                                        <span class="tab-title">
                                            {{ c.unittipocaracteristica.titulo }}
                                            {% if link.prioridad is not null %}
                                                <span class="label label-default" style="margin-left:6px;">{{ link.prioridad }}</span>
                                            {% endif %}
                                        </span>
                                    </a>
                                </li>
                                {% set inicializado = true %}
                            {% endif %}
                        {% endfor %}

                        {# Tab Ubicación #}
                        <li role="presentation">
                            {% set idUbic = 'tab_' ~ admin.uniqid ~ '_ubicacion' %}
                            <a href="#{{ idUbic }}"
                               role="tab"
                               data-toggle="tab"
                               aria-controls="{{ idUbic }}"
                               aria-selected="false"
                               style="--accent: {{ colores.lila }};">
                                <i class="fas fa-map tab-icon" aria-hidden="true"></i>
                                <span class="tab-title">{{ 'tab_ubicacion'|trans({},'messages')|capitalize }}</span>
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content no-padding">
                        {% set inicializado = false %}

                        {# Contenido de cada tab (sin sort, ya viene ordenado) #}
                        {% for index, link in object.unitCaracteristicaLinks %}
                            {% set c = link.caracteristica %}
                            {% if c is not empty and not (
                                (c.unittipocaracteristica.id == constant('App\\Entity\\ReservaUnittipocaracteristica::DB_VALOR_BRIEFING') and action == 'resumen')
                                or
                                (c.unittipocaracteristica.id == constant('App\\Entity\\ReservaUnittipocaracteristica::DB_VALOR_INVENTARIO') and action == 'resumen')
                                ) %}
                                <div class="tab-pane fade {% if not inicializado %}in active{% endif %}" id="tab_{{ admin.uniqid }}_{{ index }}">
                                    <div class="box-body container-fluid">
                                        <div class="sonata-ba-collapsed-fields">
                                            <div class="box-body table-responsive">
                                                <h3 class="visible-print">{{ c.unittipocaracteristica.titulo }}</h3>
                                                <div class="caracteristicacontent ck-content">{{ c.contenido | raw }}</div>

                                                {# Pasar la característica al parcial para usar c.medios #}
                                                {% include 'reserva_reserva_admin/show__parte_galeria.html.twig' with { caracteristica: c } %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% set inicializado = true %}
                            {% endif %}
                        {% endfor %}

                        {# Pestaña Ubicación #}
                        <div class="tab-pane fade" id="tab_{{ admin.uniqid }}_ubicacion">
                            <div class="box-body container-fluid">
                                <div class="sonata-ba-collapsed-fields">
                                    {% set addr    = object.establecimiento.direccion|default('') %}
                                    {% set ref_est = object.establecimiento.referencia|default('') %}
                                    {% set ref_obj = object.referencia|default('') %}
                                    {% set ref     = (ref_est ~ ' ' ~ ref_obj)|trim %}
                                    {% set q       = addr is not empty ? addr : (object.establecimiento.nombre|default('')) %}
                                    {% set q_url   = q|e('url') %}
                                    {% set maps    = 'https://www.google.com/maps/search/?api=1&query=' ~ q_url %}
                                    {% set mapsdir = 'https://www.google.com/maps/dir/?api=1&destination=' ~ q_url %}

                                    <div class="box-body table-responsive">
                                        <h3 class="visible-print">{{ 'tab_ubicacion'|trans({}, 'messages')|capitalize }}</h3>

                                        <p class="lead" style="margin-bottom:8px;">
                                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                            <strong>{{ 'direccion'|trans({}, 'messages')|capitalize }}:</strong>
                                            <span>{{ addr }}</span>
                                        </p>

                                        <p class="text-muted" style="font-size:1.05em; margin-bottom:12px;">
                                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                                            <strong>{{ 'referencia'|trans({}, 'messages')|capitalize }}:</strong>
                                            <span>{{ ref is not empty ? ref : ('sin_referencia'|trans({}, 'messages')|default('Sin referencia')) }}</span>
                                        </p>

                                        <div class="btn-toolbar hidden-print" role="toolbar" style="margin-bottom:10px;">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ maps }}" target="_blank" rel="noopener" class="btn btn-primary">
                                                    <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                                                    {{ 'abrir_en_google_maps'|trans({}, 'messages')|default('Abrir en Google Maps') }}
                                                </a>
                                                <a href="{{ mapsdir }}" target="_blank" rel="noopener" class="btn btn-default">
                                                    <i class="fas fa-location-arrow" aria-hidden="true"></i>
                                                    {{ 'como_llegar'|trans({}, 'messages')|default('Cómo llegar') }}
                                                </a>
                                                <a class="btn btn-default clipboard-trigger" data-text="{{ addr }}">
                                                    <i class="fas fa-copy" aria-hidden="true"></i>
                                                    {{ 'copiar_direccion'|trans({}, 'messages')|default('Copiar dirección') }}
                                                </a>
                                                <a class="btn btn-default clipboard-trigger" data-text="{{ maps }}">
                                                    <i class="fas fa-link" aria-hidden="true"></i>
                                                    {{ 'copiar_enlace'|trans({}, 'messages')|default('Copiar enlace') }}
                                                </a>
                                            </div>
                                        </div>

                                        <div class="embed-responsive embed-responsive-4by3 hidden-print gmap-wrapper" aria-label="Mapa">
                                            <iframe
                                                    class="embed-responsive-item"
                                                    id="gmap-frame-{{ object.id }}"
                                                    title="{{ 'Mapa de' }} {{ q }}"
                                                    loading="lazy"
                                                    src="https://www.google.com/maps?q={{ q_url }}&t=&z=17&ie=UTF8&iwloc=&output=embed"
                                                    referrerpolicy="no-referrer-when-downgrade"
                                                    allowfullscreen>
                                            </iframe>
                                        </div>

                                        <noscript>
                                            <p><a href="{{ maps }}" target="_blank" rel="noopener">
                                                    {{ 'ver_mapa'|trans({}, 'messages')|default('Ver mapa') }}
                                                </a></p>
                                        </noscript>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> {# /.tab-content #}
                </div> {# /.nav-tabs-custom #}

            </div>
        </div>
    </div>

    {{ sonata_block_render_event('sonata.admin.show.bottom', { 'admin': admin, 'object': object }) }}
{% endblock %}
