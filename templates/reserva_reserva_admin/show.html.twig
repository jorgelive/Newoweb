{% extends 'base_sonata_admin/show.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <style>
        /* Tabla de detalle */
        .table.table-condensed > tbody > tr > th,
        .table.table-condensed > tbody > tr > td { vertical-align: middle; }
        .sonata-ba-view-container th { width: 220px; }

        .sonata-ba-view-container th .row-icon{
            margin-right: 6px;
            opacity: .9;
            color: #667085;
            width: 1.1em;
            text-align: center;
        }

        {% include 'reserva_reserva_admin/show__parte_galeria.css.twig' %}
    </style>
{% endblock %}

{% block show %}

    <div class="sonata-ba-view">
        {{ sonata_block_render_event('sonata.admin.show.top', { 'admin': admin, 'object': object }) }}
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

                {# Macro de filas #}
                {% macro itemRow(titulo, contenido) %}
                    <tr class="sonata-ba-view-container">
                        <th class="text-muted text-uppercase" style="width:145px; letter-spacing:.2px;">{{ titulo|raw }}</th>
                        <td>{{ contenido|raw }}</td>
                    </tr>
                {% endmacro %}
                {% from _self import itemRow %}

                {# Helpers #}
                {% set isResumen = (action == 'resumen') %}
                {% set phone_clean = object.telefono is not empty ? object.telefono|replace({'-':'','+':'','(':'',')':'',' ':''}) : '' %}
                {% set esDirecto = object.channel.id == constant('App\\Entity\\ReservaChannel::DB_VALOR_DIRECTO') %}
                {% set badge_adultos = '<span class="label label-primary">x' ~ object.cantidadadultos ~ '</span>' %}
                {% set badge_ninos = object.cantidadninos > 0 ? ' <span class="label label-info">+' ~ object.cantidadninos ~ '</span>' : '' %}
                {% set marca_manual = (object.ismanual is same as(true) and not esDirecto) ? '<span class="label label-warning" title="Carga manual">D</span> ' : '' %}

                <div class="box box-primary">
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-striped table-hover table-condensed">
                            <caption class="sr-only">Detalle de la reserva</caption>
                            <tbody>

                            {{ itemRow(
                                '<i class="fas fa-user row-icon" aria-hidden="true"></i> ' ~ ('nombre'|trans({}, 'messages')|capitalize),
                            marca_manual ~ object.nombre ~ ' ' ~ badge_adultos ~ badge_ninos
                            ) }}

                            {% if (not isResumen) and object.calificacion is not empty %}
                                {{ itemRow(
                                    '<i class="fas fa-star row-icon" aria-hidden="true"></i> ' ~ ('calificacion'|trans({}, 'messages')|capitalize),
                                object.calificacion
                                ) }}
                            {% endif %}

                            {{ itemRow(
                                '<i class="fas fa-hotel row-icon" aria-hidden="true"></i> ' ~ ('alojamiento'|trans({}, 'messages')|capitalize),
                            '<strong>' ~ object.unit.establecimiento.nombre ~ ' ' ~ object.unit.nombre ~ '</strong> — ' ~ object.unit.descripcion
                            ) }}

                            {{ itemRow(
                                '<i class="fas fa-calendar-plus row-icon" aria-hidden="true"></i> ' ~ ('fecha_ingreso'|trans({}, 'messages')|capitalize),
                            ('desde'|trans({}, 'messages')|capitalize) ~ ' ' ~ (object.fechahorainicio|date('Y-m-d H:i'))
                            ) }}

                            {{ itemRow(
                                '<i class="fas fa-calendar-minus row-icon" aria-hidden="true"></i> ' ~ ('fecha_salida'|trans({}, 'messages')|capitalize),
                            ('hasta'|trans({}, 'messages')|capitalize) ~ ' ' ~ (object.fechahorafin|date('Y-m-d H:i'))
                            ) }}

                            {{ itemRow(
                                '<i class="fas fa-share-alt row-icon' ~ '' ~ '" aria-hidden="true"></i> ' ~ ('canal'|trans({}, 'messages')|capitalize),
                            object.channel.nombre ~ (not isResumen ? ' <span style="color:#fff; background-color:' ~ object.estado.color ~ ';" class="label label-default">' ~ object.estado.nombre|trans({}, 'messages') ~ '</span>' : '')
                            ) }}

                            {% if not isResumen %}
                                {{ itemRow(
                                    '<i class="fas fa-clock row-icon" aria-hidden="true"></i> ' ~ ('fecha_reserva'|trans({}, 'messages')|capitalize),
                                object.creado|date('Y-m-d H:i')
                                ) }}
                            {% endif %}

                            {% if (not isResumen) and object.enlace is not empty %}
                                {{ itemRow(
                                    '<i class="fas fa-link row-icon" aria-hidden="true"></i> ' ~ ('link'|trans({}, 'messages')|capitalize),
                                '<a href="' ~ object.enlace ~ '" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Enlace</a>'
                                ) }}
                            {% endif %}

                            {% if (not isResumen) and object.nota is not empty %}
                                {{ itemRow(
                                    '<i class="fas fa-sticky-note row-icon" aria-hidden="true"></i> ' ~ ('nota'|trans({}, 'messages')|capitalize),
                                object.nota
                                ) }}
                            {% endif %}

                            {% if (not isResumen) and object.telefono is not empty %}
                                <tr class="sonata-ba-view-container">
                                    <td colspan="2">
                                        <div class="btn-toolbar" role="toolbar">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ admin.generateObjectUrl('vcard', object) }}" class="btn btn-danger" title="vCard">
                                                    <i class="fa fa-address-card"></i> vCard
                                                </a>
                                                <a href="tel:{{ phone_clean }}" class="btn btn-success">
                                                    <i class="fa fa-phone"></i> Llamar
                                                </a>
                                                <a data-text="{{ object.telefono }}"
                                                   data-toggle="tooltip"
                                                   data-placement="bottom"
                                                   data-tooltiptext="Copiado al portapapeles"
                                                   class="btn btn-success clipboard-trigger">
                                                    <i class="fa fa-clipboard"></i> Copiar número
                                                </a>
                                                <a href="https://wa.me/{{ phone_clean }}" target="_blank" rel="noopener" class="btn btn-success">
                                                    <i class="fa fa-whatsapp"></i> Whatsapp
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>

                                <tr class="sonata-ba-view-container">
                                    <td colspan="2">
                                        <div class="btn-toolbar" role="toolbar">
                                            <div class="btn-group btn-group-sm">
                                                {% include 'reserva_reserva_admin/show__boton_checkout.html.twig' %}
                                                {% if object.channel.id == constant('App\\Entity\\ReservaChannel::DB_VALOR_BOOKING') %}
                                                    {% include 'reserva_reserva_admin/show__boton_confirmar.html.twig' %}
                                                {% endif %}
                                                {% include 'reserva_reserva_admin/show__boton_tour_economico.html.twig' %}
                                                {% include 'reserva_reserva_admin/show__boton_bienvenida.html.twig' %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}

                            </tbody>
                        </table>
                    </div>
                </div>

                {% if action != 'resumen' and object.detalles is not empty %}
                    <div class="box box-primary">
                        <div class="box-header">
                            <h4 class="box-title">{{ 'detalles'|trans({}, 'messages')|capitalize}}</h4>
                        </div>
                        <div class="box-body table-responsive no-padding">
                            <table class="table">
                                <thead>
                                <tr class="sonata-ba-view-container">
                                    <th>{{ 'tipo'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'personal'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'detalle'|trans({}, 'messages')|capitalize}}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for detalle in object.detalles %}
                                    <tr class="sonata-ba-view-container">
                                        <td>{{ detalle.tipodetalle.nombre }}</td>
                                        <td>{{ detalle.user.username }}</td>
                                        <td>{{ detalle.nota }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                {% if action != 'resumen' and object.pagos is not empty %}
                    <div class="box box-primary">
                        <div class="box-header">
                            <h4 class="box-title">{{ 'cobranzas'|trans({}, 'messages')|capitalize}}</h4>
                        </div>
                        <div class="box-body table-responsive no-padding">
                            <table class="table">
                                <thead>
                                <tr class="sonata-ba-view-container">
                                    <th>{{ 'fecha'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'personal'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'moneda'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'monto'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'nota'|trans({}, 'messages')|capitalize}}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for pago in object.pagos %}
                                    <tr class="sonata-ba-view-container">
                                        <td>{{ pago.fecha | date('Y-m-d') }}</td>
                                        <td>{{ pago.user.username }}</td>
                                        <td>{{ pago.moneda.nombre }}</td>
                                        <td>{{ pago.monto }}</td>
                                        <td>{{ pago.nota }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                {% if action != 'resumen' and object.importes is not empty %}
                    <div class="box box-primary">
                        <div class="box-header">
                            <h4 class="box-title">{{ 'precio'|trans({}, 'messages')|capitalize}}</h4>
                        </div>
                        <div class="box-body table-responsive no-padding">
                            <table class="table">
                                <thead>
                                <tr class="sonata-ba-view-container">
                                    <th>{{ 'tipo'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'moneda'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'monto'|trans({}, 'messages')|capitalize}}</th>
                                    <th>{{ 'nota'|trans({}, 'messages')|capitalize}}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for importe in object.importes %}
                                    <tr class="sonata-ba-view-container">
                                        <td>{{ importe.tipoimporte.nombre }}</td>
                                        <td>{{ importe.moneda.nombre }}</td>
                                        <td>{{ importe.monto }}</td>
                                        <td>{{ importe.nota }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}

                <div class="nav-tabs-custom nav-tabs-custom--modern">

                    {# barra con scroll horizontal en móviles #}
                    <div class="tabs-scroller tabs-scroller--wrap hidden-print">
                        <ul class="nav nav-tabs nav-tabs-modern nav-tabs-modern--wrap" role="tablist">
                            {% set linksOrdenados = object.unit.unitCaracteristicaLinks %}
                            {% for index, link in linksOrdenados %}
                                {% set c     = link.caracteristica %}
                                {% if c is not empty %}
                                    {% set id     = 'tab_' ~ admin.uniqid ~ '_' ~ index %}
                                    {% set titulo = c.unittipocaracteristica.titulo %}
                                    {% set icono  = c.unittipocaracteristica.iconclase %}
                                    {% set color  = c.unittipocaracteristica.iconcolor %}


                                    <li role="presentation" class="{% if loop.first %}active{% endif %}">
                                        <a
                                                href="#{{ id }}"
                                                role="tab"
                                                data-toggle="tab"
                                                aria-controls="{{ id }}"
                                                aria-selected="{{ loop.first ? 'true' : 'false' }}"
                                                style="--accent: {{ color }};"
                                        >
                                            <i class="fa {{ icono }} tab-icon" style="color: {{ color|e('html_attr') }};" aria-hidden="true"></i>
                                            <span class="tab-title">
                                                {{ titulo }}
                                            </span>
                                        </a>
                                    </li>
                                {% endif %}
                            {% else %}
                                {% set color_ubicacion = '#16A085' %}
                                <li role="presentation" class="disabled">
                                    <a href="javascript:void(0)" tabindex="-1">
                                        <i class="fa fa-info-circle tab-icon" style="color: {{ color_ubicacion|e('html_attr') }};" aria-hidden="true"></i>
                                        <span>{{ 'sin_caracteristicas'|trans({}, 'messages')|default('Sin características') }}</span>
                                    </a>
                                </li>
                            {% endfor %}

                            <li role="presentation">
                                <a
                                        href="#tab_{{ admin.uniqid }}_ubicacion"
                                        role="tab"
                                        data-toggle="tab"
                                        aria-controls="tab_{{ admin.uniqid }}_ubicacion"
                                        aria-selected="false"
                                        style="--accent:#954e8d;"
                                >
                                    <i class="fa fa-map-marker-alt tab-icon" aria-hidden="true"></i>
                                    <span>{{ 'tab_ubicacion'|trans({}, 'messages')|capitalize }}</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="tab-content tab-content-modern no-padding">
                        {% for index, link in linksOrdenados %}
                            {% set c = link.caracteristica %}
                            {% if c is not empty %}
                                <div class="tab-pane fade {% if loop.first %}in active{% endif %}" id="tab_{{ admin.uniqid }}_{{ index }}">
                                    <div class="box-body container-fluid">
                                        <div class="sonata-ba-collapsed-fields">
                                            <div class="box-body table-responsive">
                                                <h3 class="visible-print">{{ c.unittipocaracteristica.titulo }}</h3>
                                                <div class="caracteristicacontent ck-content">{{ c.contenido | raw }}</div>

                                                {# Pasar la característica al parcial para usar c.medios #}
                                                {% include 'reserva_reserva_admin/show__parte_galeria.html.twig' with { caracteristica: c } %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}

                        <div class="tab-pane fade" id="tab_{{ admin.uniqid }}_ubicacion">
                            <div class="box-body container-fluid">
                                <div class="sonata-ba-collapsed-fields">
                                    {# Ubicación #}
                                    {% set addr    = object.unit.establecimiento.direccion|default('') %}
                                    {% set ref     = object.unit.referencia|default('') %}
                                    {% set q       = addr is not empty ? addr : (object.unit.establecimiento.nombre ~ ' ' ~ object.unit.nombre) %}
                                    {% set q_url   = q|e('url') %}
                                    {% set maps    = 'https://www.google.com/maps/search/?api=1&query=' ~ q_url %}
                                    {% set mapsdir = 'https://www.google.com/maps/dir/?api=1&destination=' ~ q_url %}

                                    <div class="box-body">
                                        <h3 class="visible-print">{{ 'tab_ubicacion'|trans({}, 'messages')|capitalize }}</h3>

                                        <p class="lead" style="margin-bottom: 8px;">
                                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                            <strong>{{ 'direccion'|trans({}, 'messages')|capitalize }}:</strong>
                                            <span>{{ addr }}</span>
                                        </p>

                                        <p class="text-muted" style="font-size: 1.05em; margin-bottom:12px;">
                                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                                            <strong>{{ 'referencia'|trans({}, 'messages')|capitalize }}:</strong>
                                            <span>{{ ref is not empty ? ref : ('sin_referencia'|trans({}, 'messages')|default('Sin referencia')) }}</span>
                                        </p>

                                        <div class="btn-toolbar hidden-print" role="toolbar" style="margin-bottom:10px;">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ maps }}" target="_blank" rel="noopener" class="btn btn-primary">
                                                    <i class="fas fa-external-link-alt" aria-hidden="true"></i> {{ 'abrir_en_google_maps'|trans({}, 'messages')|default('Abrir en Google Maps') }}
                                                </a>
                                                <a href="{{ mapsdir }}" target="_blank" rel="noopener" class="btn btn-default">
                                                    <i class="fas fa-location-arrow" aria-hidden="true"></i> {{ 'como_llegar'|trans({}, 'messages')|default('Cómo llegar') }}
                                                </a>
                                                <a class="btn btn-default clipboard-trigger" data-text="{{ addr }}">
                                                    <i class="fas fa-copy" aria-hidden="true"></i> {{ 'copiar_direccion'|trans({}, 'messages')|default('Copiar dirección') }}
                                                </a>
                                                <a class="btn btn-default clipboard-trigger" data-text="{{ maps }}">
                                                    <i class="fas fa-link" aria-hidden="true"></i> {{ 'copiar_enlace'|trans({}, 'messages')|default('Copiar enlace') }}
                                                </a>
                                            </div>
                                        </div>

                                        <div class="embed-responsive embed-responsive-4by3 hidden-print" aria-label="Mapa">
                                            <iframe
                                                    class="embed-responsive-item"
                                                    title="{{ 'Mapa de' }} {{ q }}"
                                                    id="gmap-frame-{{ object.id }}"
                                                    loading="lazy"
                                                    src="https://www.google.com/maps?q={{ q_url }}&t=&z=17&ie=UTF8&iwloc=&output=embed"
                                                    referrerpolicy="no-referrer-when-downgrade"
                                                    allowfullscreen>
                                            </iframe>
                                        </div>

                                        <noscript>
                                            <p><a href="{{ maps }}" target="_blank" rel="noopener">{{ 'ver_mapa'|trans({}, 'messages')|default('Ver mapa') }}</a></p>
                                        </noscript>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> {# /.tab-content #}
                </div> {# /.nav-tabs-custom #}

            </div>
        </div>

    </div>

    {{ sonata_block_render_event('sonata.admin.show.bottom', { 'admin': admin, 'object': object }) }}
{% endblock %}
