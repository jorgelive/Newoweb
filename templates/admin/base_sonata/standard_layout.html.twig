{% extends '@SonataAdmin/standard_layout.html.twig' %}

{% block meta_tags %}
    {{ parent() }}
{% endblock %}

{% block sonata_head_title %}
    {# Evitamos |raw por seguridad #}
    {% if _title is not empty %}
        {{ _title|striptags }}
    {% else %}
        {% if action is defined %}
            {{ render_breadcrumbs_for_title(admin, action) }}
        {% endif %}
    {% endif %}
{% endblock %}

{% block logo %}
    <a class="logo" href="/dashboard">
        <img src="/app/images/logo_title.png" alt="">
    </a>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    {# Favicon #}
    <link rel="shortcut icon" href="{{ asset('app/images/favicon.png') }}" type="image/png" />

    {# CSS de terceros (vendors) #}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.0/main.min.css" rel="stylesheet" />
    <link href="{{ asset('/app/ckeditor/content-styles.css') }}" rel="stylesheet" />

    {# IMPORTANTE: este es el CSS publicado del bundle (vendor). Se mantiene. #}
    <link href="{{ asset('/bundles/sonataform/app.css') }}" rel="stylesheet" />

    {# Tu CSS propio, SIEMPRE después del vendor #}
    {{ encore_entry_link_tags('admin') }}


{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {# Desactivar slimscroll ANTES de que se cargue AdminLTE desde parent() #}

    {# JS propio (si lo necesitas) #}
    <script src="{{ asset('/bundles/sonataform/app.js') }}" defer></script>


    {# JS de terceros, con defer para no bloquear #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/6.0.4/bootbox.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.0/main.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar-scheduler@5.11.0/locales-all.min.js" defer></script>
    <script src="https://unpkg.com/@popperjs/core@2" defer></script>
    <script src="https://unpkg.com/tippy.js@6" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Lightbox
            $(document).on('click', '[data-toggle="lightbox"]', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).ekkoLightbox();
            });

            // Select2 focus seguro
            $(document).on("select2:open", () => {
                const el = document.querySelector(".select2-container--open .select2-search__field");
                if (el) el.focus();
            });

            // Clipboard con API moderna
            $('.clipboard-trigger').on('click', async function () {
                const text = $(this).data('text');
                const tip  = $(this).data('tooltiptext') || 'Copiado ✔';
                if (!text) return console.warn('Falta data-text');

                try {
                    await navigator.clipboard.writeText(String(text));
                    const $tooltip = $('<div id="tooltipdiv">'+ tip +'</div>');
                    $(".content-wrapper").prepend($tooltip);
                    setTimeout(() => { $tooltip.fadeOut(300, function(){ $(this).remove(); }); }, 800);
                } catch (err) {
                    console.error('Clipboard error', err);
                }
            });
        });
    </script>
{% endblock %}

{% block body_attributes -%}
    class="sonata-bc {% block admin_lte_skin_class %}{{ _skin }}{% endblock %}
    {% if _use_select2 %}sonata-select2{% endif %}
    {% if _use_icheck %}sonata-icheck{% endif %}
    {% if app.request.cookies.get('sonata_sidebar_hide') -%}
        sidebar-collapse
    {%- endif -%}"
{%- endblock -%}

{% block sonata_page_content %}
    {{ sonata_block_render({
        'type': 'app.block.tareas_block_service'
    })
    }}
    {{ parent() }}

    {{ encore_entry_script_tags('admin') }}
{% endblock sonata_page_content %}


{% block sonata_nav %}
    <nav class="navbar navbar-top">
        <a href="#" class="sidebar-toggle fa5" data-toggle="push-menu"
           role="button" title="{{ 'toggle_navigation'|trans({}, 'SonataAdminBundle') }}">
            <span class="sr-only">{{ 'toggle_navigation'|trans({}, 'SonataAdminBundle') }}</span>
        </a>

        <div class="navbar-left">
            {% block sonata_breadcrumb %}
                <div class="hidden-xs">
                    {% if _breadcrumb is not empty or action is defined %}
                        <ol class="nav navbar-top-links breadcrumb">
                            {% if _breadcrumb is empty %}
                                {% if action is defined %}
                                    {{ render_breadcrumbs(admin, action) }}
                                {% endif %}
                            {% else %}
                                {{ _breadcrumb|raw }}
                            {% endif %}
                        </ol>
                    {% endif %}
                </div>
            {% endblock sonata_breadcrumb %}
        </div>

        {% block sonata_top_nav_menu %}
            {{ parent() }}
            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    {% block sonata_top_nav_menu_locale_block %}
                        <li class="dropdown">
                            <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                                <i class="fa fa-flag fa-fw" aria-hidden="true"></i>
                                {{ 'idioma'| trans({}, 'messages') | capitalize }}
                                <i class="fa fa-caret-down" aria-hidden="true"></i>
                            </a>
                            <div class="dropdown-menu">
                                <div class="container-fluid">
                                    <div class="row">
                                        <ul class="dropdown-menu">
                                            <li role="presentation" class="dropdown-header">
                                                <i class="fa fa-language"></i>
                                                {{ 'languages'|trans({}, 'SonataTranslationBundle') }}
                                            </li>
                                            {% for locale in sonata_translation_locales %}
                                                <li role="presentation" class="{{ app.request.locale == locale ? 'active' : '' }}">
                                                    <a role="menuitem" tabindex="-1" href="{{ path('sonata.translation.locale', {'locale': locale}) }}">
                                                        {{ locale|sonata_language_name(locale)|capitalize }}
                                                    </a>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </li>
                    {% endblock %}
                </ul>
            </div>
        {% endblock sonata_top_nav_menu %}
    </nav>
{% endblock sonata_nav %}

{% block sonata_page_content_nav %}
    {% if _navbar_title is not empty
        or _tab_menu is not empty
        or _actions is not empty
        or _list_filters_actions is not empty
    %}
        <nav class="navbar-default" role="navigation">
            <div class="container-fluid">
                {% block tab_menu_navbar_header %}
                    {% if _navbar_title is not empty %}
                        <div class="navbar-header">
                            <a class="navbar-brand" href="#">{{ _navbar_title|raw }}</a>
                        </div>
                    {% endif %}
                {% endblock %}

                <div class="navbar-collapse">
                    {% if _tab_menu is not empty %}
                        <div class="navbar-left">
                            {{ _tab_menu|raw }}
                        </div>
                    {% endif %}

                    {% if admin is defined and action is defined and action == 'list' and admin.listModes|length > 1 %}
                        <div class="nav navbar-right btn-group">
                            {% for mode, settings in admin.listModes %}
                                <a href="{{ admin.generateUrl('list', app.request.query.all|merge({_list_mode: mode})) }}" class="btn btn-default navbar-btn btn-sm{% if admin.getListMode() == mode %} active{% endif %}">
                                    {% if settings.icon is not defined and settings.class is defined %}
                                        {% deprecated 'Relying on the "class" setting is deprecated since sonata-project/admin-bundle 4.9, use the "icon" setting instead' %}
                                        <i class="{{ settings.class }}" aria-hidden="true"></i>
                                    {% else %}
                                        {{ settings.icon|default('')|parse_icon }}
                                    {% endif %}
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% block sonata_admin_content_actions_wrappers %}
                        {% if _actions|replace({ '<li>': '', '</li>': '' })|trim is not empty %}
                            {% set actionCount = _actions|split('</a>')|length - 1 %}
                            <ul class="nav navbar-nav navbar-right">
                                {% if actionCount > 2 %}
                                    <li class="dropdown sonata-actions">
                                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">{{ 'link_actions'|trans({}, 'SonataAdminBundle') }} <b class="caret"></b></a>
                                        <ul class="dropdown-menu" role="menu">
                                            {{ _actions|raw }}
                                        </ul>
                                    </li>
                                {% else %}
                                    {{ _actions|raw }}
                                {% endif %}
                            </ul>
                        {% endif %}
                    {% endblock sonata_admin_content_actions_wrappers %}

                    {% if _list_filters_actions is not empty %}
                        {{ _list_filters_actions|raw }}
                    {% endif %}
                </div>
            </div>
        </nav>
    {% endif %}
{% endblock sonata_page_content_nav %}

{% block side_bar_after_nav %}
    {{ parent() }}
    <div class="btn-group btn-group-justified"></div>
{% endblock side_bar_after_nav %}
