{% extends 'admin/base_sonata/show.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .encabezado .sonata-ba-view-container th { width: 220px; }
        .encabezado .table > tbody > tr > th,
        .encabezado .table > tbody > tr > td { vertical-align: middle; }

        .sonata-ba-view-container th .row-icon { margin-right:6px; opacity:.9; color:#667085; width:1.1em; text-align:center; }

        /* Badge de pestañas solo en backoffice/show */
        .tab-badge {
            display:inline-block; margin-left:.5ch; padding:2px 6px;
            font-size:11px; line-height:1; border-radius:999px;
            background:#f0ad4e; color:#fff; vertical-align:middle;
        }
        .tabs-legend { margin:6px 0 12px; font-size:12px; color:#6c757d; }
        .tabs-legend .swatch {
            display:inline-block; height:10px; width:10px; border-radius:2px;
            background:#f0ad4e; margin-right:4px; vertical-align:middle;
        }

        {% include 'admin/reserva_reserva/show__parte_galeria.css.twig' %}
    </style>
{% endblock %}

{% block show %}

    <div class="sonata-ba-view">
        {{ sonata_block_render_event('sonata.admin.show.top', { 'admin': admin, 'object': object }) }}

        {% set isResumen = (action == 'resumen') %}

        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

                {# ============ Macro para filas del encabezado ============ #}
                {% macro itemRow(titulo, contenido) %}
                    <tr class="sonata-ba-view-container">
                        <th class="text-muted text-uppercase" style="width:145px; letter-spacing:.2px;">{{ titulo|raw }}</th>
                        <td>{{ contenido|raw }}</td>
                    </tr>
                {% endmacro %}
                {% from _self import itemRow %}

                <div class="box box-primary encabezado">
                    <div class="box-body table-responsive no-padding">
                        <table class="table table-striped table-hover table-condensed">
                            <caption class="sr-only">Encabezado del alojamiento</caption>
                            <tbody>
                            {{ itemRow(
                                '<i class="fas fa-hotel row-icon" aria-hidden="true"></i> ' ~ ('alojamiento'|trans({}, 'messages')|capitalize),
                            '<strong>' ~ object.establecimiento.nombre ~ '</strong> ' ~ object.nombre
                            ) }}

                            {{ itemRow(
                                '<i class="fas fa-align-left row-icon" aria-hidden="true"></i> ' ~ ('descripcion'|trans({}, 'messages')|capitalize),
                            object.descripcion is not empty
                            ? object.descripcion
                            : '<span class="text-muted"><em>' ~ ( 'sin_descripcion'|trans({}, 'messages')|default('Sin descripción') ) ~ '</em></span>'
                            ) }}
                            </tbody>
                        </table>
                    </div>
                </div>

                {# =================== TABS =================== #}
                <div class="nav-tabs-custom nav-tabs-custom--modern">

                    {# barra con scroll horizontal en móviles #}
                    <div class="tabs-scroller tabs-scroller--wrap hidden-print">
                        <ul class="nav nav-tabs nav-tabs-modern nav-tabs-modern--wrap" role="tablist">
                            {% set inicializado = false %}
                            {% set hayRestringidas = false %}

                            {# Iterar sobre links (orden ya viene por @OrderBy) #}
                            {% for index, link in object.unitCaracteristicaLinks %}
                                {% set c = link.caracteristica %}
                                {% if c is not empty %}
                                    {% set tipo      = c.unittipocaracteristica %}
                                    {% set esGated   = tipo.restringidoEnResumen %}
                                    {% set permitido = (not isResumen) or (not esGated) %}

                                    {% if esGated %}{% set hayRestringidas = true %}{% endif %}

                                    {% if permitido %}
                                        {% set idTab  = 'tab_' ~ admin.uniqid ~ '_' ~ index %}
                                        {% set color  = tipo.iconcolor %}
                                        <li role="presentation" class="{% if not inicializado %}active{% endif %}">
                                            <a href="#{{ idTab }}"
                                               role="tab"
                                               data-toggle="tab"
                                               aria-controls="{{ idTab }}"
                                               aria-selected="{{ (not inicializado) ? 'true' : 'false' }}"
                                               style="--accent: {{ color }};">
                                                <i class="fas {{ tipo.iconclase }} tab-icon" style="color: {{ color|e('html_attr') }};" aria-hidden="true"></i>
                                                <span class="tab-title">
                                                    {{ tipo.titulo }}
                                                    {% if (not isResumen) and esGated %}
                                                        <span class="tab-badge" title="Tipo restringido: no se muestra en el resumen público">R</span>
                                                    {% endif %}
                                                </span>
                                            </a>
                                        </li>
                                        {% set inicializado = true %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {# Tab Ubicación #}
                            <li role="presentation" class="{% if not inicializado %}active{% endif %}">
                                {% set idUbic = 'tab_' ~ admin.uniqid ~ '_ubicacion' %}
                                {% set color_ubicacion = '#16A085' %}
                                <a href="#{{ idUbic }}"
                                   role="tab"
                                   data-toggle="tab"
                                   aria-controls="{{ idUbic }}"
                                   aria-selected="{{ (not inicializado) ? 'true' : 'false' }}"
                                   style="--accent: {{ color_ubicacion }};">
                                    <i class="fas fa-map-marker-alt tab-icon" style="color: {{ color_ubicacion|e('html_attr') }};" aria-hidden="true"></i>
                                    <span class="tab-title">{{ 'tab_ubicacion'|trans({},'messages')|capitalize }}</span>
                                </a>
                            </li>
                        </ul>
                    </div>

                    {# Leyenda de badges (solo backoffice y si existe al menos un tipo restringido) #}
                    {% if (not isResumen) and hayRestringidas %}
                        <div class="tabs-legend hidden-print">
                            <span class="swatch" aria-hidden="true"></span>
                            <strong>R</strong> = Tipo restringido (oculto en el resumen público).
                        </div>
                    {% endif %}

                    <div class="tab-content tab-content-modern no-padding">
                        {% set inicializado = false %}

                        {# Contenido de cada tab #}
                        {% for index, link in object.unitCaracteristicaLinks %}
                            {% set c = link.caracteristica %}
                            {% if c is not empty %}
                                {% set tipo      = c.unittipocaracteristica %}
                                {% set esGated   = tipo.restringidoEnResumen %}
                                {% set permitido = (not isResumen) or (not esGated) %}

                                {% if permitido %}
                                    <div class="tab-pane fade {% if not inicializado %}in active{% endif %}" id="tab_{{ admin.uniqid }}_{{ index }}">
                                        <div class="box-body container-fluid">
                                            <div class="sonata-ba-collapsed-fields">
                                                <div class="box-body table-responsive">
                                                    <h3 class="visible-print">{{ tipo.titulo }}</h3>
                                                    <div class="caracteristicacontent ck-content">{{ c.contenido | raw }}</div>

                                                    {# Galería de medios #}
                                                    {% include 'admin/reserva_reserva/show__parte_galeria.html.twig' with { caracteristica: c } %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% set inicializado = true %}
                                {% endif %}
                            {% endif %}
                        {% endfor %}

                        {# Pestaña Ubicación #}
                        <div class="tab-pane fade {% if not inicializado %}in active{% endif %}" id="tab_{{ admin.uniqid }}_ubicacion">
                            <div class="box-body container-fluid">
                                <div class="sonata-ba-collapsed-fields">
                                    {% set addr    = object.establecimiento.direccion|default('') %}
                                    {% set ref_est = object.establecimiento.referencia|default('') %}
                                    {% set ref_obj = object.referencia|default('') %}
                                    {% set ref     = (ref_est ~ ' ' ~ ref_obj)|trim %}
                                    {% set q       = addr is not empty ? addr : (object.establecimiento.nombre|default('')) %}
                                    {% set q_url   = q|e('url') %}
                                    {% set maps    = 'https://www.google.com/maps/search/?api=1&query=' ~ q_url %}
                                    {% set mapsdir = 'https://www.google.com/maps/dir/?api=1&destination=' ~ q_url %}

                                    <div class="box-body table-responsive">
                                        <h3 class="visible-print">{{ 'tab_ubicacion'|trans({}, 'messages')|capitalize }}</h3>

                                        <p class="lead" style="margin-bottom:8px;">
                                            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
                                            <strong>{{ 'direccion'|trans({}, 'messages')|capitalize }}:</strong>
                                            <span>{{ addr }}</span>
                                        </p>

                                        <p class="text-muted" style="font-size:1.05em; margin-bottom:12px;">
                                            <i class="fas fa-info-circle" aria-hidden="true"></i>
                                            <strong>{{ 'referencia'|trans({}, 'messages')|capitalize }}:</strong>
                                            <span>{{ ref is not empty ? ref : ('sin_referencia'|trans({}, 'messages')|default('Sin referencia')) }}</span>
                                        </p>

                                        <div class="btn-toolbar hidden-print" role="toolbar" style="margin-bottom:10px;">
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ maps }}" target="_blank" rel="noopener" class="btn btn-primary">
                                                    <i class="fas fa-external-link-alt" aria-hidden="true"></i>
                                                    {{ 'abrir_en_google_maps'|trans({}, 'messages')|default('Abrir en Google Maps') }}
                                                </a>
                                                <a href="{{ mapsdir }}" target="_blank" rel="noopener" class="btn btn-default">
                                                    <i class="fas fa-location-arrow" aria-hidden="true"></i>
                                                    {{ 'como_llegar'|trans({}, 'messages')|default('Cómo llegar') }}
                                                </a>
                                                <a class="btn btn-default clipboard-trigger" data-text="{{ addr }}">
                                                    <i class="fas fa-copy" aria-hidden="true"></i>
                                                    {{ 'copiar_direccion'|trans({}, 'messages')|default('Copiar dirección') }}
                                                </a>
                                                <a class="btn btn-default clipboard-trigger" data-text="{{ maps }}">
                                                    <i class="fas fa-link" aria-hidden="true"></i>
                                                    {{ 'copiar_enlace'|trans({}, 'messages')|default('Copiar enlace') }}
                                                </a>
                                            </div>
                                        </div>

                                        <div class="embed-responsive embed-responsive-4by3 hidden-print gmap-wrapper" aria-label="Mapa">
                                            <iframe
                                                    class="embed-responsive-item"
                                                    id="gmap-frame-{{ object.id }}"
                                                    title="{{ 'Mapa de' }} {{ q }}"
                                                    loading="lazy"
                                                    src="https://www.google.com/maps?q={{ q_url }}&t=&z=17&ie=UTF8&iwloc=&output=embed"
                                                    referrerpolicy="no-referrer-when-downgrade"
                                                    allowfullscreen>
                                            </iframe>
                                        </div>

                                        <noscript>
                                            <p><a href="{{ maps }}" target="_blank" rel="noopener">
                                                    {{ 'ver_mapa'|trans({}, 'messages')|default('Ver mapa') }}
                                                </a></p>
                                        </noscript>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> {# /.tab-content #}
                </div> {# /.nav-tabs-custom #}

            </div>
        </div>
    </div>

    {{ sonata_block_render_event('sonata.admin.show.bottom', { 'admin': admin, 'object': object }) }}
{% endblock %}
