{% extends 'oweb/admin/base_sonata/edit.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <style>

    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script type="text/javascript">
        (function (window, document, $) {
            'use strict';

            var FORMAT = 'YYYY/MM/DD HH:mm';

            function isInicioInput(input) {
                if (!input || input.tagName !== 'INPUT') return false;
                return /\[fechahorainicio\]$/.test(input.name || '');
            }

            function getBaseName(name) {
                return name.replace(/\[fechahorainicio\]$/g, '');
            }

            function getFinInput(baseName) {
                var finName = baseName + '[fechahorafin]';
                return document.querySelector('input[name="' + finName + '"]');
            }

            function parseMoment(value) {
                var m = moment((value || '').trim(), FORMAT, true);
                return m.isValid() ? m : null;
            }

            function actualizarFin(inicioInput, fromDatepicker) {
                if (!isInicioInput(inicioInput)) return null;

                var name = inicioInput.name || '';
                var baseName = getBaseName(name);

                var inicioMoment = parseMoment(inicioInput.value);
                if (!inicioMoment) return null;

                var oldMoment = parseMoment(inicioInput.dataset.oldValForFin || '');
                var finInput = getFinInput(baseName);
                if (!finInput) return null;

                var finMoment = parseMoment(finInput.value);
                var newFinMoment;

                if (!oldMoment || !finMoment) {
                    newFinMoment = inicioMoment.clone().add(20, 'hours');
                } else {
                    var diff = inicioMoment.diff(oldMoment);
                    newFinMoment = finMoment.clone().add(diff, 'ms');
                }

                finInput.value = newFinMoment.format(FORMAT);
                finInput.dispatchEvent(new Event('change', { bubbles: true }));

                inicioInput.dataset.oldValForFin = inicioInput.value;

                return {
                    finInput,
                    finName: baseName + '[fechahorafin]'
                };
            }

            // Guardar valor previo
            document.addEventListener('focusin', e => {
                var target = e.target;
                if (isInicioInput(target)) {
                    target.dataset.oldValForFin = target.value || '';
                }
            });

            // Escritura manual
            document.addEventListener('input', e => {
                var target = e.target;
                if (isInicioInput(target)) {
                    actualizarFin(target, false);
                }
            });

            // DateTimePicker
            if ($ && $.fn && $.fn.datetimepicker) {

                $(document).on('dp.show', function (e) {
                    $(e.target).find('input').first().trigger('focus');
                });

                $(document).on('dp.change', function (e) {
                    var input = $(e.target).find('input').get(0);
                    if (!isInicioInput(input)) return;

                    // 1. Actualizamos
                    var result = actualizarFin(input, true);
                    if (!result) return;

                    var finInput = result.finInput;
                    var finName  = result.finName;

                    // 2. Cerramos picker de inicio
                    var dtpInicio = $(e.target).data('DateTimePicker');
                    if (dtpInicio && dtpInicio.hide) dtpInicio.hide();

                    // 3. Seleccionamos datepicker de fin usando EXACTAMENTE el finName
                    var $pickerFin = $('input[name="' + finName + '"]')
                        .closest('.input-group.date, .datetimepicker, .date');

                    var dtpFin = $pickerFin.data('DateTimePicker');
                    if (dtpFin && dtpFin.show) dtpFin.show();

                    // 4. Focus + seleccionar contenido
                    finInput.focus();
                    finInput.select();
                });
            }

        })(window, document, jQuery);
    </script>

{% endblock %}
