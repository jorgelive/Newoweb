{% extends '@SonataAdmin/CRUD/base_edit.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <style>
        .field-container {overflow-x: auto; padding-bottom: 20px;}
        .input-group .fecha {width: 95px;}
        .input-group .fechahora {width: 130px;}
        .nav-tabs-custom{ margin-top: 30px; padding-top: 8px; margin-bottom: 10px; border-top: #3c8dbc solid 2px;}
        .nav-tabs-custom:first-of-type{ margin-top: 10px;}
        .select2-container{min-width: 140px;}
        .horadropdown{display: inline-flex; vertical-align: top;}
        .horadropdown .select2-container{min-width: 70px;}
        .inputwarning{border-color: #ce563f;
        }
        .serviciofechainicio{background-color: rgba(22, 157, 28, 0.25);}
        .inputwarning:focus{border-color: #DD1144;
            -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
            box-shadow: inset 0 1px 1px rgba(0,0,0,.075);
        }
        .select2-results__options > li.loading-results > div > div:nth-child(2){display: none;}

        .campo-_delete .checkbox label {
            display: inline-block;
            white-space: nowrap;
        }
        .campo-_delete .checkbox label::after {
            font-family: "Font Awesome\ 5 Free";
            content: "\f12d";
            display: inline;
            vertical-align: middle;
        }

    </style>

{% endblock %}

{% block javascripts %}

    {{ parent() }}

    <script src="{{ asset('/app/ckeditor/ckeditor.js') }}"></script>

    {# Debe ir DESPUÉS de jquery-ui.js y ANTES de tu propio JS #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <script type="text/javascript">
        (function ($) {

            // ============================
            //  autoFit plugin (delegación)
            // ============================
            (function () {
                // Helper compartido
                function resizeElement($el) {
                    var val = ($el.val() || '').replace(' ', '-');
                    var fontSize = $el.css('font-size');

                    var elemento = $('<span style="font-size: ' + fontSize + '; padding: 0; display: inline-block; position: absolute; visibility:hidden;">' + val + '</span>').appendTo('body');
                    var contentWidth = elemento.outerWidth();
                    elemento.remove();

                    $el.width(contentWidth + 'px');
                }

                // Listener delegado para inputs/textarea marcados con autoFit
                $(document).on('input', '.js-autofit', function () {
                    resizeElement($(this));
                });

                // Listener delegado para contenedores datetime marcados
                $(document).on('dp.change', '.js-autofit-datetime', function () {
                    var $input = $(this).find('input').first();
                    if ($input.length) {
                        resizeElement($input);
                    }
                });

                $.fn.autoFit = function () {
                    return this.each(function () {
                        var $this = $(this);

                        // Marca el elemento para que el listener delegado lo atienda
                        if (!$this.hasClass('js-autofit')) {
                            $this.addClass('js-autofit');
                        }

                        // Marca el padre para eventos de dp.change
                        var $parent = $this.parent();
                        if ($parent.length && !$parent.hasClass('js-autofit-datetime')) {
                            $parent.addClass('js-autofit-datetime');
                        }
                    });
                };
            })();

            // ============================
            //  checkDelete plugin (delegación)
            // ============================
            (function () {

                var ejecutando = false;

                function borrar($checkbox) {
                    var $fila             = $checkbox.closest('tr');
                    var $siguienteFila    = $fila.next('tr');
                    var $subSiguienteFila = $siguienteFila.next('tr');
                    var $tbody            = $fila.closest('tbody');

                    bootbox.confirm({
                        message: "¿Estas seguro que quieres eliminar el registro?",
                        buttons: {
                            confirm: { label: 'Si', className: 'btn-danger' },
                            cancel:  { label: 'No', className: 'btn-success' }
                        },
                        callback: function (result) {
                            if (result === true) {
                                if ($subSiguienteFila.hasClass('splitted2')) $subSiguienteFila.remove();
                                if ($siguienteFila.hasClass('splitted'))   $siguienteFila.remove();

                                $fila.remove();
                                $tbody.closest('table').trigger('table:rowdeleted');

                                if ($tbody.children('tr').length === 0) {
                                    $tbody.closest('table').remove();
                                }
                            } else {
                                // Revertir el check
                                if (typeof $checkbox.iCheck === 'function') {
                                    $checkbox.iCheck('uncheck');
                                } else {
                                    $checkbox.prop('checked', false).trigger('change');
                                }
                            }
                        }
                    });
                }

                // Listener delegado: sirve para inputs existentes y nuevos
                function bindDelegatedHandler() {
                    if ($.fn.checkDelete._bound) return;
                    $.fn.checkDelete._bound = true;

                    // Soporta iCheck (ifChecked) y también change nativo
                    $(document).on('ifChecked.checkDelete change.checkDelete', "[id$='_delete']", function (e) {
                        // si es change y está desmarcado, no hacemos nada
                        if (e.type === 'change' && !this.checked) return;

                        if (ejecutando) return;
                        ejecutando = true;

                        borrar($(this));

                        setTimeout(function () {
                            ejecutando = false;
                        }, 300);
                    });
                }

                $.fn.checkDelete = function () {
                    // El plugin ahora solo asegura que el handler delegado esté activo
                    bindDelegatedHandler();
                    return this;
                };

            })();

            // ============================
            //  Fix sortable de "medios"
            // ============================
            function fixMediosSortable(context) {
                var $scope = context ? $(context) : $(document);

                $scope
                    .find('.medios-collection-wrapper tbody.sonata-ba-tbody')
                    .each(function () {
                        var $tbody = $(this);

                        if (!$tbody.data('medios-sortable-fixed')) {
                            if ($tbody.data('ui-sortable')) {
                                $tbody.sortable('option', 'handle', '.sonata-ba-sortable-handler');
                                $tbody.sortable('option', 'delay', 120);
                                $tbody.data('medios-sortable-fixed', true);
                            }
                        }
                    });
            }

            // ============================
            //  CKEditor helpers
            // ============================
            const editors = new Map();

            function getCkeditorConfigBase() {
                return {
                    toolbar: {
                        shouldNotGroupWhenFull: true
                    },
                    htmlSupport: {
                        allow: [
                            { name: 'img', classes: true, attributes: true, styles: true }
                        ]
                    },
                    ui: {
                        viewportOffset: { top: 30 }
                    }
                };
            }

            function initCkEditors(scope) {
                var $scope = scope ? $(scope) : $(document);

                // Editables
                $scope.find('.ckeditor').each(function () {
                    var $textarea = $(this);
                    if ($textarea.hasClass('ckrendered')) {
                        return;
                    }

                    var config = getCkeditorConfigBase();

                    ClassicEditor.create(this, config).then(editor => {
                        editors.set(editor.id, editor);
                    }).catch(error => {
                        //console.error(error);
                    });

                    $textarea.addClass('ckrendered');
                });

                // Solo lectura
                $scope.find('.ckeditorread').each(function () {
                    var $textarea = $(this);
                    if ($textarea.hasClass('ckrendered')) {
                        return;
                    }

                    var configReadOnly = getCkeditorConfigBase();
                    configReadOnly.readOnly = true;

                    ClassicEditor.create(this, configReadOnly).then(editor => {
                        editor.enableReadOnlyMode('my-feature-id');
                    }).catch(error => {
                        //console.error(error);
                    });

                    $textarea.addClass('ckrendered');
                });
            }

            // ============================
            //  Inicialización común de formularios
            // ============================
            function initFormEnhancements(scope) {
                var $scope = scope ? $(scope) : $(document);

                // Activa el handler delegado de checkDelete
                $scope.find("[id$='_delete']").checkDelete();

                // Si quieres reactivar autoFit, descomenta esto:
                // $scope.find('table input.form-control').not('.fechahora, .fecha').autoFit();
                // $scope.find('table textarea.form-control').autoFit();

                $scope.find('input.readonly').attr('readonly', 'readonly');
                $scope.find('input.disabled').attr('disabled', 'disabled');
                $scope.find('input.paralelo').closest('tr').addClass('paralelo');

                initCkEditors($scope);
            }

            // ============================
            //  LISTENERS NATIVOS (delegación)
            // ============================

            document.addEventListener('DOMContentLoaded', function () {
                initFormEnhancements(document);
                fixMediosSortable();
            });

            document.addEventListener('sonata.add_element', function (ev) {
                var target = ev.target || document;
                initFormEnhancements(target);
                fixMediosSortable(target);
            });

            // Bloquear menú contextual solo en el handler de sortable (delegado)
            document.addEventListener('contextmenu', function (ev) {
                if (ev.target && ev.target.closest && ev.target.closest('.sonata-ba-sortable-handler')) {
                    ev.preventDefault();
                }
            });

            // Preview de imagen para input[type=file] con data-preview-img (delegado)
            document.addEventListener('change', function (ev) {
                var input = ev.target;
                if (!input || input.type !== 'file') return;

                var targetId = input.getAttribute('data-preview-img');
                if (!targetId) return;

                var img = document.getElementById(targetId);
                if (!img) return;

                if (input.files && input.files[0]) {
                    var file = input.files[0];
                    var url  = URL.createObjectURL(file);
                    img.src  = url;
                    img.style.display = 'inline-block';
                    img.onload = function () {
                        URL.revokeObjectURL(url);
                    };
                } else {
                    img.removeAttribute('src');
                    img.style.display = 'none';
                }
            });

            // Exponer helpers globales
            window.initFormEnhancements = initFormEnhancements;
            window.fixMediosSortable    = fixMediosSortable;
            window.ckEditorsMap         = editors;

        })(jQuery);
    </script>


{% endblock %}


