{#
Reemplazo del autocomplete estándar de Sonata con:
- Contexto padre OPCIONAL (solo si 'context' está definido y no vacío)
- Si hay context y el padre tiene valor => se agrega siempre /{parentId} al PATH
- Caché PERSISTENTE GLOBAL por campo (sobrevive a cierres/re-renders)
- Invalidación de caché solo si cambia el valor del padre
- Soporte explícito para context == 'filter' en parámetros AJAX
- dropdownParent seguro en modales
- Integración con el modal de "crear" (auto-selección del registro creado)
#}

{% set has_context = context is defined and context is not empty %}

<select id="{{ id }}_autocomplete_input" data-sonata-select2="false"
        {%- if read_only|default(false) %} readonly="readonly"{% endif -%}
        {%- if disabled %} disabled="disabled"{% endif -%}
        {%- if multiple %} multiple="multiple"{% endif -%}>
    {%- for idx, val in value|filter((val, idx) => idx~'' != '_labels') -%}
        <option value="{{ val }}" selected>{{ value['_labels'][idx] }}</option>
    {%- endfor -%}
</select>

<div id="{{ id }}_hidden_inputs_wrap">
    {% if multiple -%}
        {%- for idx, val in value|filter((val, idx) => idx~'' != '_labels') -%}
            <input type="hidden" name="{{ full_name }}[]" {%- if disabled %} disabled="disabled"{% endif %} value="{{ val }}">
        {%- endfor -%}
    {% else -%}
        <input type="hidden" name="{{ full_name }}" {%- if disabled %} disabled="disabled"{% endif %} value="{{ value[0]|default('') }}">
    {% endif -%}
</div>

{% if sonata_admin.field_description and sonata_admin.field_description.hasAssociationAdmin %}
    <div id="field_actions_{{ id }}" class="field-actions">
        {% set display_btn_add = sonata_admin.edit != 'admin'
            and sonata_admin.field_description.associationadmin.hasRoute('create')
            and sonata_admin.field_description.associationadmin.isGranted('CREATE')
            and btn_add %}
        {% if display_btn_add %}
            <a href="{{ sonata_admin.field_description.associationadmin.generateUrl(
                'create',
                sonata_admin.field_description.getOption('link_parameters', {})
            ) }}"
               onclick="return start_field_dialog_form_add_{{ id }}(this);"
               class="btn btn-success btn-sm sonata-ba-action"
               title="{{
               btn_translation_domain|default(null) is same as(false)
               ? btn_add
               : btn_add|trans({}, btn_translation_domain|default(btn_catalogue))
               }}">
                <i class="fas fa-plus-circle"></i>
                {{
                btn_translation_domain|default(null) is same as(false)
                ? btn_add
                : btn_add|trans({}, btn_translation_domain|default(btn_catalogue))
                }}
            </a>
            {% include '@SonataAdmin/CRUD/Association/edit_modal.html.twig' %}
            {% include '@SonataAdmin/CRUD/Association/edit_many_script.html.twig' %}
        {% endif %}
    </div>
{% endif %}

<script>
    {% autoescape 'js' %}
    jQuery(function ($) {
        var autocompleteInput = $('#{{ id }}_autocomplete_input');

        // ------- Contexto padre opcional -------
        var HAS_CONTEXT = {{ has_context ? 'true' : 'false' }};
        var selectorchain = null;
        var parentSelector = null;

        {% if has_context %}
        // 'context' viene como: /regex/g, "reemplazo"
        selectorchain = "{{ full_name|raw }}".replace( {{ context|raw }} );
        parentSelector = $(":input[name='" + selectorchain + "']");
        {% endif %}

        // ------- Caché global persistente por campo -------
        var GLOBAL_CACHE_SLOT = '__sonataSelect2Cache';
        window[GLOBAL_CACHE_SLOT] = window[GLOBAL_CACHE_SLOT] || {};
        var FIELD_KEY = '{{ id }}';
        window[GLOBAL_CACHE_SLOT][FIELD_KEY] = window[GLOBAL_CACHE_SLOT][FIELD_KEY] || {};
        var __s2Cache = window[GLOBAL_CACHE_SLOT][FIELD_KEY];

        // Índice opcional para limitar entradas en memoria
        var MAX_TERM_ENTRIES = 40;
        var termIndex = __s2Cache.__index || [];
        __s2Cache.__index = termIndex;

        function rememberKey(key) {
            if (termIndex.indexOf(key) === -1) {
                termIndex.push(key);
                if (termIndex.length > MAX_TERM_ENTRIES) {
                    var oldKey = termIndex.shift();
                    delete __s2Cache[oldKey];
                }
            }
        }

        // Track del último valor de padre para invalidar solo si cambia
        var LAST_PARENT_VAL = null;
        function getParentVal() {
            if (!HAS_CONTEXT || !parentSelector || !parentSelector.length) return '';
            var v = parentSelector.val();
            return (typeof v === 'undefined' || v === null) ? '' : String(v);
        }
        {% if has_context %}
        LAST_PARENT_VAL = getParentVal();
        if (parentSelector && parentSelector.length) {
            parentSelector.on('change', function(){
                var newVal = getParentVal();
                if (newVal === LAST_PARENT_VAL) return; // nada cambió
                Object.keys(__s2Cache).forEach(function(k){ delete __s2Cache[k]; });
                __s2Cache.__index = []; termIndex = __s2Cache.__index;
                LAST_PARENT_VAL = newVal;
                autocompleteInput.val(null).trigger('change');
            });
        }
        {% endif %}

        var baseUrl = "{{ url ?: path(route.name, route.parameters|default([])) }}";

        var select2Options = {
            {% set allowClearPlaceholder = (not multiple and not required) ? ' ' : '' %}
            placeholder: '{{ placeholder ?: allowClearPlaceholder }}',
            allowClear: {{ required ? 'false' : 'true' }},
            enable: {{ disabled ? 'false' : 'true' }},
            readonly: {{ attr.read_only|default(false) ? 'true' : 'false' }},
            minimumInputLength: {{ minimum_input_length }},
            theme: 'bootstrap',
            width: function() { return Admin.get_select2_width(jQuery(this)); },
            language: "{{ canonicalize_locale_for_select2() }}",
            dropdownAutoWidth: {{ dropdown_auto_width ? 'true' : 'false' }},
            containerCssClass: '{{ container_css_class ~ ' form-control' }}',
            dropdownCssClass: '{{ dropdown_css_class }}',
            dropdownParent: autocompleteInput.parents('.modal').length > 0 ? autocompleteInput.parents('.modal') : $(document.body),

            ajax: {
                url: function() {
                    // Solo depende de context: si hay padre con valor, agrega /{parentId} al PATH
                    if (HAS_CONTEXT) {
                        var pv = getParentVal();
                        if (pv) {
                            return baseUrl.replace(/\/+$/,'') + '/' + encodeURIComponent(pv);
                        }
                    }
                    // Sin context o sin valor de padre -> ruta base
                    return baseUrl;
                },
                dataType: 'json',
                delay: {{ delay == 100 and quiet_millis != 100 ? quiet_millis : delay }},
                cache: {{ cache ? 'true' : 'false' }},

                // -------- TRANSPORT con caché global persistente --------
                transport: function (params, success, failure) {
                    var TERM_NAME = '{{ req_param_name_search }}';
                    var PAGE_NAME = '{{ req_param_name_page_number }}';

                    var term = (params.data && params.data[TERM_NAME]) || '';
                    var page = (params.data && params.data[PAGE_NAME]) || 1;
                    var parentVal = getParentVal();

                    var cacheKey = FIELD_KEY + '::' + parentVal + '::' + (term || '') + '::' + page;

                    if (__s2Cache[cacheKey]) {
                        success(__s2Cache[cacheKey]);
                        return;
                    }

                    var request = $.ajax(params);
                    request.then(function (data) {
                        __s2Cache[cacheKey] = data;
                        // Cachea todo (termino/página) para máximo rendimiento
                        rememberKey(cacheKey);
                        success(data);
                    }, failure);

                    return request;
                },

                processResults: function (data, params) {
                    return {
                        results: data.items,
                        pagination: { more: data.more }
                    };
                },

                data: function (params) {
                    {% block sonata_type_model_autocomplete_ajax_request_parameters %}
                    var payload = {
                        '{{ req_param_name_search }}': params.term,
                        '{{ req_param_name_items_per_page }}': {{ items_per_page }},
                        '{{ req_param_name_page_number }}': (typeof params.page !== 'undefined' ? params.page : 1),

                        {% if sonata_admin.admin %}
                        'uniqid': '{{ sonata_admin.admin.uniqid }}',
                        '_sonata_admin': '{{ sonata_admin.admin.baseCodeRoute|e('js') }}',
                        {% elseif admin_code %}
                        '_sonata_admin': '{{ admin_code|e('js') }}',
                        {% endif %}

                        {% if app.request.query.get('subclass') %}
                        'subclass': '{{ app.request.query.get('subclass') }}',
                        {% endif %}
                    };

                    {% if context == 'filter' %}
                    payload['field'] = '{{ full_name|replace({'filter[': '', '][value]': '', '__':'.'}) }}';
                    payload['_context'] = 'filter';
                    {% else %}
                    payload['field'] = '{{ name }}';
                    {% endif %}

                    // NO se pasan parámetros extra del padre por query. Solo path.

                    {% if req_params is not empty %}
                    {% for key, value in req_params %}
                    payload['{{ key }}'] = '{{ value }}';
                    {% endfor %}
                    {% endif %}

                    return payload;
                    {% endblock %}
                },
            },

            escapeMarkup: function (m) { return m; }, // permitimos HTML si safe_label=true

            templateResult: function (item) {
                if (typeof item.label === 'undefined') { item.label = item.text; }
                return {% block sonata_type_model_autocomplete_dropdown_item_format -%}
                {% if safe_label|default(false) %}
                '<div class="{{ dropdown_item_css_class }}">' + item.label + '<\/div>'
                {% else %}
                jQuery('<div class="{{ dropdown_item_css_class }}">').text(item.label).prop('outerHTML')
                {% endif %}
                {%- endblock %};
            },

            templateSelection: function (item) {
                if (typeof item.label === 'undefined') { item.label = item.text; }
                return {% block sonata_type_model_autocomplete_selection_format -%}
                {% if safe_label|default(false) %}
                item.label
                {% else %}
                jQuery('<div>').text(item.label).prop('innerHTML')
                {% endif %}
                {%- endblock %};
            },
        };

        // Inicializa Select2
        autocompleteInput.select2(select2Options);

        // ------- Sincronización de hidden inputs -------
        autocompleteInput.on('select2:select select2:unselect', function(e) {
            if (e.type === 'select2:select') { e.added = e.params.data; }
            if (e.type === 'select2:unselect') { e.removed = e.params.data; }

            // remove input(s)
            if (typeof e.removed !== 'undefined' && e.removed !== null) {
                var removedItems = e.removed;
                {% if multiple %}
                if (!$.isArray(removedItems)) { removedItems = [removedItems]; }
                for (var i = 0; i < removedItems.length; i++) {
                    var el = removedItems[i];
                    $('#{{ id }}_hidden_inputs_wrap input:hidden[value="'+el.id+'"]').remove();
                }
                {% else %}
                $('#{{ id }}_hidden_inputs_wrap input:hidden').val('');
                {% endif %}
            }

            // add input(s)
            if (typeof e.added !== 'undefined' && e.added !== null) {
                var addedItems = e.added;
                {% if multiple %}
                if (!$.isArray(addedItems)) { addedItems = [addedItems]; }
                for (var j = 0; j < addedItems.length; j++) {
                    var el2 = addedItems[j];
                    $('#{{ id }}_hidden_inputs_wrap').append(
                        '<input type="hidden" name="{{ full_name }}[]" value="'+el2.id+'" />'
                    );
                }
                {% else %}
                $('#{{ id }}_hidden_inputs_wrap input:hidden').val(addedItems.id);
                {% endif %}
            }
        });

        // Antes de enviar, removemos el select visible
        autocompleteInput.closest('form').submit(function(){
            autocompleteInput.remove();
            return true;
        });

        // ------- Auto-selección del registro creado desde el modal -------
        {% if sonata_admin.field_description
            and sonata_admin.field_description.hasAssociationAdmin
            and btn_add
            and sonata_admin.field_description.associationadmin.hasRoute('create')
            and sonata_admin.field_description.associationadmin.hasAccess('create') %}

        {% set create_url = sonata_admin.field_description.associationadmin.generateUrl(
            'create',
            sonata_admin.field_description.getOption('link_parameters', {})
        ) %}

        $(document).ajaxSuccess(function(event, xhr, settings) {
            if (typeof xhr.responseJSON !== 'undefined') {
                if ('{{ create_url }}'.indexOf(settings.url) !== -1
                    && typeof xhr.responseJSON !== 'string'
                    && xhr.responseJSON.result == 'ok') {

                    var item = new Option(
                        new DOMParser().parseFromString(xhr.responseJSON.objectName, "text/html").documentElement.textContent,
                        xhr.responseJSON.objectId,
                        true, true
                    );

                    autocompleteInput.append(item).trigger('change');

                    autocompleteInput.trigger({
                        type: 'select2:select',
                        params: { data: autocompleteInput.select2('data') }
                    });

                    {% if multiple %}
                    $('#{{ id }}_hidden_inputs_wrap').append(
                        '<input type="hidden" name="{{ full_name }}[]" value="'+xhr.responseJSON.objectId+'" />'
                    );
                    {% else %}
                    $('#{{ id }}_hidden_inputs_wrap').html(
                        '<input type="hidden" name="{{ full_name }}" value="'+xhr.responseJSON.objectId+'" />'
                    );
                    {% endif %}
                }
            }
        });
        {% endif %}
    });
    {% endautoescape %}
</script>
