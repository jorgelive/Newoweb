security:
    role_hierarchy:
        ROLE_USER: []

        # --- 1. Lógica de Cascada (CRUD) ---
        # Esto permite que tus Voters sean sencillos.
        # Si preguntas is_granted('ROLE_..._SHOW'), responderá TRUE incluso si el usuario tiene WRITE o DELETE.

        # Maestros
        ROLE_MAESTROS_WRITE: [ ROLE_MAESTROS_SHOW ]
        ROLE_MAESTROS_DELETE: [ ROLE_MAESTROS_WRITE ]

        # Operaciones
        ROLE_OPERACIONES_WRITE:     [ROLE_OPERACIONES_SHOW]
        ROLE_OPERACIONES_DELETE:    [ROLE_OPERACIONES_WRITE]

        # Reservas
        ROLE_RESERVAS_WRITE:        [ROLE_RESERVAS_SHOW]
        ROLE_RESERVAS_DELETE:       [ROLE_RESERVAS_WRITE]

        # Mensajes
        ROLE_MENSAJES_WRITE:        [ROLE_MENSAJES_SHOW]
        ROLE_MENSAJES_DELETE:       [ROLE_MENSAJES_WRITE]

        # --- 2. Roles Operativos (Personal de Campo) ---
        # Estos roles suelen heredar solo de ROLE_USER porque su acceso es específico vía Voters.

        ROLE_LIMPIEZA:           [ROLE_USER]
        ROLE_MANTENIMIENTO:      [ROLE_USER]
        ROLE_CONDUCTOR:          [ROLE_USER]
        ROLE_TRASLADISTA:        [ROLE_USER]
        ROLE_GUIA:               [ROLE_USER]

        # Admin: Control total de los módulos de negocio
        # Al heredar los _DELETE, automáticamente hereda _WRITE y _SHOW de todos.
        ROLE_ADMIN:
            - ROLE_USER
            - ROLE_MAESTROS_DELETE
            - ROLE_OPERACIONES_DELETE
            - ROLE_RESERVAS_DELETE
            - ROLE_MENSAJES_DELETE
            # El Admin también puede actuar como personal de campo si es necesario
            - ROLE_LIMPIEZA
            - ROLE_MANTENIMIENTO
            - ROLE_CONDUCTOR
            - ROLE_TRASLADISTA
            - ROLE_GUIA

        # Super Admin: Acceso técnico total + Impersonación
        ROLE_SUPER_ADMIN:
            - ROLE_ADMIN
            - ROLE_ALLOWED_TO_SWITCH

    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'

    providers:
        app_user_provider:
            entity:
                class: App\Entity\User
                property: username

    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false

        api:
            pattern: ^/api
            stateless: true
            # Si usas algún autenticador, añádelo aquí.
            # Si es pública por ahora, déjala sin seguridad o con 'security: false'
            security: false
            #host: '%app.host.api%'

        main:
            lazy: true
            provider: app_user_provider

            form_login:
                login_path: app_login
                check_path: app_login
                default_target_path: /
                always_use_default_target_path: false
                #use_referer: true
                enable_csrf: true

            logout:
                path: app_logout
                target: app_login
                invalidate_session: true

            remember_me:
                secret: '%env(APP_SECRET)%'
                name: REMEMBERME
                lifetime: 2629746
                path: /
                domain: '%env(FRAMEWORK_SESION_COOKIE_DOMAIN)%'

    access_control:
        # Login/logout públicos
        - { path: '^/login$',  roles: PUBLIC_ACCESS }
        - { path: '^/logout$', roles: PUBLIC_ACCESS }

        # APIs públicas específicas (las tuyas)
        - { path: '^/app/cotizacioncotservicio/ical$',                 roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservareserva/ical$',                        roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservareserva/\d+/resumen/[A-Za-z0-9]+$',    roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservaunit/\d+/ical$',                       roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservaunit/\d+/ical\.ics$',                  roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservaunitnexo/\d+/ical$',                   roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservaunitnexo/\d+/ical\.ics$',              roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservaunit/\d+/inventario$',                 roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/reservaunit/\d+/resumen$',                    roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/cotizacioncotizacion/\d+/resumen/[A-Za-z0-9]+$',  roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/cotizacioncotizacion/\d+/operaciones/[A-Za-z0-9]+$', roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/cotizacionfile/\d+/resumen/[A-Za-z0-9]+$',    roles: PUBLIC_ACCESS, methods: [GET] }
        - { path: '^/app/fitdieta/\d+/resumen/[A-Za-z0-9]+$',          roles: PUBLIC_ACCESS, methods: [GET] }

        - { path: '^/locale', roles: PUBLIC_ACCESS }

        # PANEL: todos requiere login (por host)
        - { host: '%app.host.panel%', path: '^/', roles: ROLE_USER }

        # OWEB legacy (si quieres, también por host)
        - { host: '%app.host.oweb%',  path: '^/', roles: ROLE_USER }

        # Resto público
        - { path: '^/.*', roles: PUBLIC_ACCESS }