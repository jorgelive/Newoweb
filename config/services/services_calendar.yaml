# config/services/services_calendar.yaml
services:

    _defaults:
        autowire: true
        autoconfigure: true

    # MÓDULO CALENDAR: Re-definición explícita (Override)
    # ==========================================================================
    # Aunque el bloque general 'App\' escanea src/, esta definición específica es
    # OBLIGATORIA para garantizar la correcta aplicación de tags vía '_instanceof'.
    #
    # Motivo Técnico:
    # El escáner general carga los servicios, pero en estructuras anidadas puede
    # fallar al resolver la implementación de interfaces antes de la compilación.
    # Este bloque fuerza una segunda pasada con 'autoconfigure: true' habilitado
    # explícitamente para este namespace, asegurando que:
    #   1. Se detecte 'CalendarProviderInterface'.
    #   2. Se inyecte el tag 'app.calendar_provider'.
    #   3. El 'ProviderRegistry' reciba los servicios en el Iterator.
    #
    # Sin este bloque, los servicios existen en el contenedor pero son "invisibles"
    # para el '!tagged_iterator' (aparecen sin tags).
    # ==========================================================================

    App\Calendar\:
        resource: '../../src/Calendar/'
        exclude:
            - '../src/Calendar/Dto/'
            - '../src/Calendar/Entity/'

    # =========================
    # controllers del módulo Calendar
    # (fuera de src/Controller/)
    # =========================
    App\Calendar\Controller\:
        resource: '../../src/Calendar/Controller/'
        autowire: true
        autoconfigure: true
        tags:
            - 'controller.service_arguments'

    # =========================
    # Reglas por instanceof
    # =========================
    _instanceof:
        App\Calendar\Provider\CalendarProviderInterface:
            tags:
                - 'app.calendar_provider'

    # =========================
    # Provider Registry
    # =========================
    App\Calendar\Provider\ProviderRegistry:
        arguments:
            $providers: !tagged_iterator app.calendar_provider